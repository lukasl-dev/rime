name: Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v4

    - uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - uses: cachix/cachix-action@v14
      with:
        name: rime
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - run: nix build .#rime

    - name: Integration with Claude Code
      run: |
        export HOME=$GITHUB_WORKSPACE/temp_home
        mkdir -p $HOME
        nix shell nixpkgs#bun --command bunx @anthropic-ai/claude-code mcp add rime -- ./result/bin/rime stdio
        
        for i in {1..3}; do
          echo "Checking MCP health (attempt $i)..."
          OUTPUT=$(nix shell nixpkgs#bun --command bunx @anthropic-ai/claude-code mcp list 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "rime:.*Connected"; then
            echo "Validation successful!"
            exit 0
          fi
          sleep 5
        done
        echo "Validation failed: rime did not connect to Claude Code"
        exit 1

    - name: Integration with opencode
      run: |
        export HOME=$GITHUB_WORKSPACE/temp_home_opencode
        export XDG_CONFIG_HOME=$HOME/.config
        mkdir -p $XDG_CONFIG_HOME/opencode
        mkdir -p $HOME/.opencode
        
        # Create config in multiple possible locations
        CONFIG_CONTENT='{
          "mcp": {
            "rime": {
              "command": ["'"$GITHUB_WORKSPACE"'/result/bin/rime", "stdio"],
              "enabled": true,
              "type": "local"
            }
          }
        }'
        
        echo "$CONFIG_CONTENT" > $XDG_CONFIG_HOME/opencode/config.json
        echo "$CONFIG_CONTENT" > $HOME/.opencode/config.json
        echo "$CONFIG_CONTENT" > opencode.json
        
        for i in {1..3}; do
          echo "Checking opencode MCP health (attempt $i)..."
          # Pass HOME and XDG_CONFIG_HOME explicitly to nix run
          OUTPUT=$(HOME=$HOME XDG_CONFIG_HOME=$XDG_CONFIG_HOME nix run github:sst/opencode -- mcp list 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -qi "rime.*connected"; then
            echo "Validation successful!"
            exit 0
          fi
          sleep 5
        done
        echo "Validation failed: rime did not connect to opencode"
        find $HOME -name "*.json"
        exit 1
